# ============================================================
# –ü–†–û–°–¢–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê –ß–ï–†–ï–ó –í–ï–ë-–ö–û–ù–°–û–õ–¨ TIMEWEB
# ============================================================
#
# –®–ê–ì 1: –û—Ç–∫—Ä–æ–π –≤–µ–±-–∫–æ–Ω—Å–æ–ª—å
#   https://timeweb.cloud ‚Üí —Ç–≤–æ–π —Å–µ—Ä–≤–µ—Ä (5.42.99.76) ‚Üí –∫–Ω–æ–ø–∫–∞ "–ö–æ–Ω—Å–æ–ª—å"
#
# –®–ê–ì 2: –°–∫–æ–ø–∏—Ä—É–π –í–ï–°–¨ —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ (–æ—Ç cat –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏)
#         –∏ –≤—Å—Ç–∞–≤—å –≤ –∫–æ–Ω—Å–æ–ª—å (Ctrl+V –∏–ª–∏ –ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏)
#
# –®–ê–ì 3: –ù–∞–∂–º–∏ Enter –∏ —Å–ª–µ–¥—É–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º
#
# ============================================================

# –ö–û–ú–ê–ù–î–ê –î–õ–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø (—Å–∫–æ–ø–∏—Ä—É–π –æ—Ç "cat" –¥–æ –∫–æ–Ω—Ü–∞):

cat > /root/timeweb-full-setup.sh << 'EOFSETUPSCRIPT'
#!/bin/bash
#
# –ü–û–õ–ù–ê–Ø –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê MANSONI BACKEND –ù–ê TIMEWEB CLOUD
# –í–∫–ª—é—á–∞–µ—Ç: PostgreSQL + PostgREST + Nginx + coturn + TURN endpoint
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
#   1. –ó–∞–≥—Ä—É–∑–∏ —Å–∫—Ä–∏–ø—Ç: scp timeweb-full-setup.sh root@5.42.99.76:/root/
#   2. –ó–∞–≥—Ä—É–∑–∏ –º–∏–≥—Ä–∞—Ü–∏–∏: scp supabase/.temp/all-migrations.sql root@5.42.99.76:/root/
#   3. –ó–∞–ø—É—Å—Ç–∏: ssh root@5.42.99.76 "chmod +x /root/timeweb-full-setup.sh && /root/timeweb-full-setup.sh"
#

set -e  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# ==============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–∑–∞–¥–∞–π –∑–¥–µ—Å—å –∏–ª–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è)
# ==============================================================================

DB_NAME="${DB_NAME:-mansoni}"
DB_USER="${DB_USER:-mansoni_app}"
DB_PASSWORD="${DB_PASSWORD:-}"  # –ë—É–¥–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
TURN_SECRET="${TURN_SECRET:-7c0fa2d30f7a20fb54bceb89dc3984553a2ef5226b5a66f45ae64db74fcc1d00}"
SERVER_IP="${SERVER_IP:-5.42.99.76}"
DOMAIN="${DOMAIN:-}"  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: api.mansoni.ru

# ==============================================================================
# –ù–ê–ß–ê–õ–û –£–°–¢–ê–ù–û–í–ö–ò
# ==============================================================================

echo
log_info "=========================================================="
log_info "  MANSONI BACKEND - –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê"
log_info "=========================================================="
echo
log_info "–°–µ—Ä–≤–µ—Ä:       $SERVER_IP"
log_info "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:  $DB_NAME"
log_info "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $DB_USER"
log_info "TURN Secret:  ${TURN_SECRET:0:16}...${TURN_SECRET: -8}"
echo

# –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –ë–î –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
if [ -z "$DB_PASSWORD" ]; then
    read -sp "–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î $DB_USER: " DB_PASSWORD
    echo
    read -sp "–ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ä–æ–ª—å: " DB_PASSWORD_CONFIRM
    echo
    if [ "$DB_PASSWORD" != "$DB_PASSWORD_CONFIRM" ]; then
        log_error "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!"
        exit 1
    fi
fi

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Å–µ–∫—Ä–µ—Ç–∞
JWT_SECRET=$(openssl rand -base64 32)
log_info "JWT Secret —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${JWT_SECRET:0:16}..."

read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É? (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    log_warning "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

# ==============================================================================
# –®–ê–ì 1: –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´
# ==============================================================================
log_info "–®–∞–≥ 1/14: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update
apt upgrade -y
log_success "–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"

# ==============================================================================
# –®–ê–ì 2: –£–°–¢–ê–ù–û–í–ö–ê POSTGRESQL 15
# ==============================================================================
log_info "–®–∞–≥ 2/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL 15..."
apt install -y postgresql-15 postgresql-contrib-15
systemctl start postgresql
systemctl enable postgresql
log_success "PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"

# ==============================================================================
# –®–ê–ì 3: –£–°–¢–ê–ù–û–í–ö–ê –†–ê–°–®–ò–†–ï–ù–ò–ô POSTGRESQL
# ==============================================================================
log_info "–®–∞–≥ 3/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π..."
apt install -y postgresql-15-pg-stat-monitor || log_warning "pg_stat_monitor –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
log_success "–†–∞—Å—à–∏—Ä–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# ==============================================================================
# –®–ê–ì 4: –°–û–ó–î–ê–ù–ò–ï –ë–î –ò –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
# ==============================================================================
log_info "–®–∞–≥ 4/14: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."

sudo -u postgres psql <<EOF
-- –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE USER $DB_USER WITH PASSWORD '$DB_PASSWORD';

-- –°–æ–∑–¥–∞–Ω–∏–µ –ë–î
CREATE DATABASE $DB_NAME OWNER $DB_USER;

-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
\c $DB_NAME

-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- –ü—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
GRANT ALL PRIVILEGES ON DATABASE $DB_NAME TO $DB_USER;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO $DB_USER;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO $DB_USER;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO $DB_USER;

-- –ü—Ä–∞–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO $DB_USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO $DB_USER;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON FUNCTIONS TO $DB_USER;
EOF

log_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞"

# ==============================================================================
# –®–ê–ì 5: –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ô
# ==============================================================================
log_info "–®–∞–≥ 5/14: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."

if [ -f "/root/all-migrations.sql" ]; then
    PGPASSWORD="$DB_PASSWORD" psql -U $DB_USER -d $DB_NAME -f /root/all-migrations.sql
    log_success "–ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    log_warning "–§–∞–π–ª /root/all-migrations.sql –Ω–µ –Ω–∞–π–¥–µ–Ω - –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
    log_warning "–ó–∞–≥—Ä—É–∑–∏ —Ñ–∞–π–ª –ø–æ–∑–∂–µ: scp supabase/.temp/all-migrations.sql root@$SERVER_IP:/root/"
    log_warning "–ò –ø—Ä–∏–º–µ–Ω–∏: PGPASSWORD='$DB_PASSWORD' psql -U $DB_USER -d $DB_NAME -f /root/all-migrations.sql"
fi

# ==============================================================================
# –®–ê–ì 6: –ù–ê–°–¢–†–û–ô–ö–ê POSTGRESQL
# ==============================================================================
log_info "–®–∞–≥ 6/14: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL..."

cp /etc/postgresql/15/main/postgresql.conf /etc/postgresql/15/main/postgresql.conf.backup
cp /etc/postgresql/15/main/pg_hba.conf /etc/postgresql/15/main/pg_hba.conf.backup

tee -a /etc/postgresql/15/main/postgresql.conf > /dev/null <<EOF

# ====== Mansoni Custom Settings ======
listen_addresses = 'localhost'
max_connections = 200
shared_buffers = 2GB
effective_cache_size = 6GB
maintenance_work_mem = 512MB
work_mem = 10MB
random_page_cost = 1.1
effective_io_concurrency = 200
EOF

tee -a /etc/postgresql/15/main/pg_hba.conf > /dev/null <<EOF

# ====== Mansoni Access Rules ======
local   $DB_NAME        $DB_USER                                scram-sha-256
host    $DB_NAME        $DB_USER        127.0.0.1/32            scram-sha-256
host    $DB_NAME        $DB_USER        ::1/128                 scram-sha-256
EOF

systemctl restart postgresql
log_success "PostgreSQL –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# ==============================================================================
# –®–ê–ì 7: –£–°–¢–ê–ù–û–í–ö–ê POSTGREST
# ==============================================================================
log_info "–®–∞–≥ 7/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgREST..."

cd /tmp
POSTGREST_VERSION="v12.0.2"
wget -q https://github.com/PostgREST/postgrest/releases/download/$POSTGREST_VERSION/postgrest-$POSTGREST_VERSION-linux-static-x64.tar.xz
tar xJf postgrest-$POSTGREST_VERSION-linux-static-x64.tar.xz
mv postgrest /usr/local/bin/
chmod +x /usr/local/bin/postgrest
rm postgrest-$POSTGREST_VERSION-linux-static-x64.tar.xz

log_success "PostgREST —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(postgrest --version | head -n 1)"

# ==============================================================================
# –®–ê–ì 8: –ù–ê–°–¢–†–û–ô–ö–ê POSTGREST
# ==============================================================================
log_info "–®–∞–≥ 8/14: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgREST..."

mkdir -p /etc/postgrest

tee /etc/postgrest/mansoni.conf > /dev/null <<EOF
db-uri = "postgres://$DB_USER:$DB_PASSWORD@localhost:5432/$DB_NAME"
db-schemas = "public"
db-anon-role = "$DB_USER"
db-pool = 10
db-pool-timeout = 10

server-host = "127.0.0.1"
server-port = 3000

jwt-secret = "$JWT_SECRET"
jwt-secret-is-base64 = false

max-rows = 1000
EOF

log_success "PostgREST –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# ==============================================================================
# –®–ê–ì 9: –°–û–ó–î–ê–ù–ò–ï SYSTEMD –°–ï–†–í–ò–°–ê POSTGREST
# ==============================================================================
log_info "–®–∞–≥ 9/14: –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è PostgREST..."

tee /etc/systemd/system/postgrest-mansoni.service > /dev/null <<EOF
[Unit]
Description=PostgREST API for Mansoni
After=postgresql.service
Requires=postgresql.service

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/postgrest /etc/postgrest/mansoni.conf
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start postgrest-mansoni
systemctl enable postgrest-mansoni

sleep 2

if systemctl is-active --quiet postgrest-mansoni; then
    log_success "PostgREST —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
else
    log_error "PostgREST —Å–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –õ–æ–≥–∏: journalctl -u postgrest-mansoni -n 50"
    exit 1
fi

# ==============================================================================
# –®–ê–ì 10: –£–°–¢–ê–ù–û–í–ö–ê COTURN
# ==============================================================================
log_info "–®–∞–≥ 10/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ coturn..."

apt install -y coturn

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è coturn
sed -i 's/#TURNSERVER_ENABLED=1/TURNSERVER_ENABLED=1/' /etc/default/coturn

log_success "coturn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# ==============================================================================
# –®–ê–ì 11: –ù–ê–°–¢–†–û–ô–ö–ê COTURN
# ==============================================================================
log_info "–®–∞–≥ 11/14: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ coturn..."

tee /etc/turnserver.conf > /dev/null <<EOF
# Mansoni TURN Server Configuration
listening-port=3478
tls-listening-port=5349

# –í–Ω–µ—à–Ω–∏–π IP
external-ip=$SERVER_IP

# Realm
realm=mansoni.ru

# –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
use-auth-secret
static-auth-secret=$TURN_SECRET

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
verbose
log-file=/var/log/turnserver.log

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
max-bps=1000000
bps-capacity=0

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
fingerprint
lt-cred-mech
no-multicast-peers
no-cli
no-tlsv1
no-tlsv1_1

# –ü–æ—Ä—Ç—ã –¥–ª—è –º–µ–¥–∏–∞
min-port=49152
max-port=65535
EOF

systemctl restart coturn
systemctl enable coturn

sleep 2

if systemctl is-active --quiet coturn; then
    log_success "coturn –∑–∞–ø—É—â–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
else
    log_error "coturn –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –õ–æ–≥–∏: journalctl -u coturn -n 50"
    exit 1
fi

# ==============================================================================
# –®–ê–ì 12: –£–°–¢–ê–ù–û–í–ö–ê NODE.JS –î–õ–Ø TURN ENDPOINT
# ==============================================================================
log_info "–®–∞–≥ 12/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js..."

curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs

log_success "Node.js —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(node --version)"

# ==============================================================================
# –®–ê–ì 13: –°–û–ó–î–ê–ù–ò–ï TURN CREDENTIALS ENDPOINT
# ==============================================================================
log_info "–®–∞–≥ 13/14: –°–æ–∑–¥–∞–Ω–∏–µ TURN credentials endpoint..."

mkdir -p /opt/mansoni-turn-api
cd /opt/mansoni-turn-api

tee /opt/mansoni-turn-api/package.json > /dev/null <<'EOF'
{
  "name": "mansoni-turn-api",
  "version": "1.0.0",
  "type": "module",
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5"
  }
}
EOF

npm install --production

tee /opt/mansoni-turn-api/server.js > /dev/null <<'EOFJS'
import express from 'express';
import cors from 'cors';
import crypto from 'crypto';

const app = express();
const PORT = 3001;

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
const TURN_SECRET = process.env.TURN_SECRET || '';
const SERVER_IP = process.env.SERVER_IP || '5.42.99.76';
const TTL_SECONDS = 86400; // 24 —á–∞—Å–∞

app.use(cors());
app.use(express.json());

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// TURN credentials endpoint (—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å Supabase —Ñ–æ—Ä–º–∞—Ç)
app.post('/turn-credentials', (req, res) => {
  try {
    const timestamp = Math.floor(Date.now() / 1000) + TTL_SECONDS;
    const username = `${timestamp}:mansoni`;
    
    const hmac = crypto.createHmac('sha1', TURN_SECRET);
    hmac.update(username);
    const password = hmac.digest('base64');

    res.json({
      ttl: TTL_SECONDS,
      uris: [
        `turn:${SERVER_IP}:3478?transport=udp`,
        `turn:${SERVER_IP}:3478?transport=tcp`,
        `turns:${SERVER_IP}:5349?transport=tcp`
      ],
      username: username,
      password: password
    });
  } catch (error) {
    console.error('Error generating TURN credentials:', error);
    res.status(500).json({ error: 'Internal server error' });
  }
});

app.listen(PORT, '127.0.0.1', () => {
  console.log(`TURN credentials API listening on http://127.0.0.1:${PORT}`);
});
EOFJS

# –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è TURN API
tee /etc/systemd/system/mansoni-turn-api.service > /dev/null <<EOF
[Unit]
Description=Mansoni TURN Credentials API
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mansoni-turn-api
Environment="TURN_SECRET=$TURN_SECRET"
Environment="SERVER_IP=$SERVER_IP"
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl start mansoni-turn-api
systemctl enable mansoni-turn-api

sleep 2

if systemctl is-active --quiet mansoni-turn-api; then
    log_success "TURN API –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://127.0.0.1:3001"
else
    log_error "TURN API –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è. –õ–æ–≥–∏: journalctl -u mansoni-turn-api -n 50"
    exit 1
fi

# ==============================================================================
# –®–ê–ì 14: –£–°–¢–ê–ù–û–í–ö–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê NGINX
# ==============================================================================
log_info "–®–∞–≥ 14/14: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx..."

apt install -y nginx

tee /etc/nginx/sites-available/mansoni-api > /dev/null <<'EOFNGINX'
upstream postgrest {
    server 127.0.0.1:3000;
    keepalive 64;
}

upstream turn_api {
    server 127.0.0.1:3001;
    keepalive 8;
}

server {
    listen 80;
    server_name _;

    access_log /var/log/nginx/mansoni-api-access.log;
    error_log /var/log/nginx/mansoni-api-error.log;

    client_max_body_size 10M;

    # CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type, Accept, apikey, x-client-info' always;
    add_header 'Access-Control-Max-Age' '3600' always;

    # OPTIONS –∑–∞–ø—Ä–æ—Å—ã
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # TURN credentials endpoint
    location /turn-credentials {
        proxy_pass http://turn_api/turn-credentials;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # PostgREST API
    location / {
        proxy_pass http://postgrest;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }
}
EOFNGINX

ln -sf /etc/nginx/sites-available/mansoni-api /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

nginx -t
systemctl restart nginx
systemctl enable nginx

log_success "Nginx —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# ==============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê FIREWALL
# ==============================================================================
log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ firewall..."

apt install -y ufw
ufw --force disable

ufw default deny incoming
ufw default allow outgoing

# –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ—Ä—Ç—ã
ufw allow 22/tcp comment 'SSH'
ufw allow 80/tcp comment 'HTTP'
ufw allow 443/tcp comment 'HTTPS'

# TURN ports
ufw allow 3478/tcp comment 'TURN TCP'
ufw allow 3478/udp comment 'TURN UDP'
ufw allow 5349/tcp comment 'TURNS'
ufw allow 49152:65535/udp comment 'TURN media'

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î
ufw deny 5432/tcp comment 'Block PostgreSQL'

ufw --force enable

log_success "Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# ==============================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–• –ë–≠–ö–ê–ü–û–í
# ==============================================================================
log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤..."

mkdir -p /var/backups/mansoni

tee /usr/local/bin/backup-mansoni.sh > /dev/null <<EOF
#!/bin/bash
BACKUP_DIR="/var/backups/mansoni"
DATE=\$(date +%Y%m%d_%H%M%S)

export PGPASSWORD="$DB_PASSWORD"
pg_dump -U $DB_USER -d $DB_NAME -F c -f \$BACKUP_DIR/mansoni_\$DATE.dump

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
find \$BACKUP_DIR -name "mansoni_*.dump" -mtime +7 -delete

echo "[\$DATE] Backup completed"
EOF

chmod +x /usr/local/bin/backup-mansoni.sh

(crontab -l 2>/dev/null; echo "0 3 * * * /usr/local/bin/backup-mansoni.sh >> /var/log/mansoni-backup.log 2>&1") | crontab -

log_success "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)"

# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# ==============================================================================

echo
log_success "=========================================================="
log_success "  –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
log_success "=========================================================="
echo
log_info "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo
echo "  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:"
echo "    Host:     localhost"
echo "    Port:     5432"
echo "    Database: $DB_NAME"
echo "    User:     $DB_USER"
echo "    Password: [—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω]"
echo
echo "  PostgREST API:"
echo "    Internal: http://127.0.0.1:3000"
echo "    External: http://$SERVER_IP:80"
echo
echo "  TURN Credentials API:"
echo "    Internal: http://127.0.0.1:3001/turn-credentials"
echo "    External: http://$SERVER_IP:80/turn-credentials"
echo
echo "  TURN Server:"
echo "    turn:$SERVER_IP:3478?transport=udp"
echo "    turn:$SERVER_IP:3478?transport=tcp"
echo "    turns:$SERVER_IP:5349?transport=tcp"
echo
echo "  –°–µ–∫—Ä–µ—Ç—ã (–¥–æ–±–∞–≤—å –≤ .env.local):"
echo "    VITE_TIMEWEB_API_URL=\"http://$SERVER_IP\""
echo "    VITE_TIMEWEB_API_KEY=\"$JWT_SECRET\""
echo "    VITE_TURN_CREDENTIALS_URL=\"http://$SERVER_IP/turn-credentials\""
echo
log_info "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:"
echo
echo "  1. –ü—Ä–æ–≤–µ—Ä—å PostgREST API:"
echo "     curl http://$SERVER_IP/"
echo
echo "  2. –ü—Ä–æ–≤–µ—Ä—å TURN credentials:"
echo "     curl -X POST http://$SERVER_IP/turn-credentials"
echo
echo "  3. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "     systemctl status postgresql postgrest-mansoni coturn mansoni-turn-api nginx"
echo
log_info "üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo
echo "  –õ–æ–≥–∏ PostgREST:     journalctl -u postgrest-mansoni -f"
echo "  –õ–æ–≥–∏ TURN API:      journalctl -u mansoni-turn-api -f"
echo "  –õ–æ–≥–∏ coturn:        journalctl -u coturn -f"
echo "  –õ–æ–≥–∏ PostgreSQL:    tail -f /var/log/postgresql/postgresql-15-main.log"
echo "  –õ–æ–≥–∏ Nginx:         tail -f /var/log/nginx/mansoni-api-access.log"
echo "  Backup –≤—Ä—É—á–Ω—É—é:     /usr/local/bin/backup-mansoni.sh"
echo
log_success "–ì–æ—Ç–æ–≤–æ! üöÄ"
echo
log_info "–ù–µ –∑–∞–±—É–¥—å –æ–±–Ω–æ–≤–∏—Ç—å .env.local –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ!"

EOFSETUPSCRIPT

chmod +x /root/timeweb-full-setup.sh
echo ""
echo "========================================="
echo "–°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
echo "========================================="
echo ""
/root/timeweb-full-setup.sh