{
  "req_id": "REQ-0075",
  "title": "Message Backup & Account Export (GDPR Data Export)",
  "version": "1.0",
  "status": "in-design",
  "domain": "messaging",
  "depends_on": ["REQ-0064", "REQ-0073"],
  "use_cases": [
    "user taps 'Download my data' in settings â†’ generates export",
    "export includes all messages, media, contacts (GDPR compliant)",
    "user receives download link (valid 30 days)",
    "user can view export timeline for all past exports"
  ],
  "export_scope": {
    "data_included": [
      "all messages (text, media, voice) user sent or received",
      "conversation metadata (names, members, timestamps)",
      "contacts (all users user interacted with)",
      "read receipts history",
      "media files (images, videos, voice recordings)",
      "settings & preferences"
    ],
    "data_excluded": [
      "deleted messages (hard-deleted > 30 days)",
      "other user's messages (only messages user participated in)",
      "group/channel messages where user was not member at send time"
    ]
  },
  "export_flow": {
    "request": {
      "trigger": "user taps 'Export data' in settings",
      "confirmation_modal": "Are you sure? Export is prepared, link valid 30 days",
      "confirmation_action": "POST /v1/user/exports"
    },
    "processing": {
      "server_job": [
        "1. create data_exports table entry (status=pending)",
        "2. query all user's messages â†’ aggregate into JSON",
        "3. download all media files from S3",
        "4. zip everything (messages.json + media/)",
        "5. upload ZIP to secure bucket (encrypted)",
        "6. generate 30-day signed URL",
        "7. update export status=completed, send email with link"
      ],
      "latency": "<5 min for typical user (depends on media volume)"
    }
  },
  "export_format": {
    "json_structure": {
      "user_profile": {
        "user_id": "UUID",
        "username": "alice",
        "email": "alice@example.com",
        "export_date": "2026-02-15T15:35:00Z"
      },
      "conversations": [
        {
          "conversation_id": "UUID",
          "name": "Project Discussion",
          "type": "group|dm",
          "created_at": "2026-01-01T10:00:00Z",
          "participants": ["alice", "bob", "charlie"],
          "message_count": 1254
        }
      ],
      "messages": [
        {
          "message_id": "UUID",
          "conversation_id": "UUID",
          "sender": "alice",
          "timestamp": "2026-02-15T15:35:00Z",
          "content": "Hello, this is my message",
          "status": "delivered|read|edited|deleted",
          "edited_count": 0,
          "reactions": [{"emoji": "ðŸ‘", "count": 3}],
          "media": {
            "type": "image",
            "filename": "photo_id_123.jpg",
            "size_bytes": 245000
          }
        }
      ],
      "contacts": [
        {
          "user_id": "UUID",
          "username": "bob",
          "email": "bob@example.com",
          "message_count": 523
        }
      ]
    }
  },
  "media_export": {
    "organization": "media/ subfolder in ZIP",
    "structure": {
      "media/images/": "all images user sent/received",
      "media/videos/": "all videos",
      "media/voice/": "all voice recordings",
      "media/documents/": "all documents"
    },
    "filename_format": "original_{message_id}.{ext}",
    "example": "media/images/original_uuid-123.jpg"
  },
  "export_storage": {
    "secure_s3_bucket": "user-data-exports (encrypted, versioning off)",
    "retention": "30 days (deleted automatically via S3 lifecycle policy)",
    "access": "signed URLs only (user can't list bucket)",
    "encryption": "AES-256 at rest (AWS managed)"
  },
  "export_database_schema": {
    "data_exports_table": {
      "columns": [
        "export_id UUID PK",
        "user_id UUID FK",
        "requested_at timestamp",
        "completed_at timestamp",
        "status enum (pending, completed, failed, expired)",
        "export_size_bytes integer",
        "s3_key text (path to ZIP)",
        "download_url_expires_at timestamp",
        "download_count integer",
        "PRIMARY KEY (export_id)",
        "INDEX (user_id, requested_at)"
      ]
    }
  },
  "recurring_exports": {
    "feature": "schedule automated exports (premium feature)",
    "schedule_options": "daily, weekly, monthly",
    "storage": "up to 3 previous exports kept, older deleted",
    "schema_addition": "data_exports.is_recurring bool, recurring_schedule enum"
  },
  "export_notification": {
    "trigger": "export completed",
    "email_sent": "to user's email with download link",
    "email_content": [
      "Your data export is ready",
      "Download link: https://exports.app.com/secure/uuid?token=xxx",
      "Link expires: 2026-03-15",
      "This contains all your messages, media, contacts"
    ]
  },
  "download_protection": {
    "mechanism": "signed URLs with rate limiting",
    "rate_limit": "max 10 downloads per export per hour",
    "tracking": "log each download (audit trail for GDPR)",
    "failure_handling": "if link expired, user must request new export"
  },
  "export_history": {
    "ui_view": "'My data exports' page shows:",
    "columns": [
      "Export date",
      "Status (completed/pending/expired)",
      "Size",
      "Download (if available)",
      "Delete (user can delete old exports)"
    ]
  },
  "local_backup": {
    "mobile_feature": "user can backup conversations to device (iCloud/Google Drive)",
    "mechanism": "export JSON + select media to device storage",
    "restore": "future feature - reimport archive to new account"
  },
  "encryption_in_transit": {
    "transport": "HTTPS + TLS 1.3",
    "zip_file": "optionally encrypted with user password (future v2)"
  },
  "api_endpoints": {
    "request_export": {
      "endpoint": "POST /v1/user/exports",
      "payload": {
        "include_media": true,
        "include_contacts": true
      },
      "response": {
        "export_id": "UUID",
        "status": "pending",
        "estimated_seconds": 240
      }
    },
    "list_exports": {
      "endpoint": "GET /v1/user/exports",
      "params": {
        "limit": 10,
        "offset": 0
      },
      "response": [
        {
          "export_id": "UUID",
          "requested_at": "2026-02-15T15:35:00Z",
          "completed_at": "2026-02-15T15:40:00Z",
          "status": "completed",
          "size_bytes": 1024000,
          "download_url": "https://exports.app.com/...",
          "expires_at": "2026-03-15T15:40:00Z"
        }
      ]
    },
    "delete_export": {
      "endpoint": "DELETE /v1/user/exports/{id}",
      "response": {
        "success": true
      }
    }
  },
  "testing": {
    "scenarios": [
      "request export â†’ status = pending initial",
      "wait 5min â†’ export completes, status = completed",
      "download export ZIP â†’ file contains messages.json + media/",
      "verify messages.json structure matches schema",
      "verify media files are present (count matches)",
      "download same export 2x in 1 hour â†’ succeeds (rate limit not hit)",
      "download export after 30 days â†’ link expired, error",
      "delete old export â†’ removed from listing",
      "request export with only contacts â†’ no media folder"
    ]
  },
  "monitoring": {
    "metrics": [
      "export.requests_per_hour",
      "export.avg_processing_time_seconds",
      "export.failure_rate_percent",
      "export.avg_size_mb",
      "export.downloads_per_export_avg"
    ],
    "alerts": [
      "export job fails > 5% (database query error?)",
      "export processing > 10min p95 (stalled?)",
      "S3 storage used for exports > 10GB (cleanup needed)"
    ]
  }
}
