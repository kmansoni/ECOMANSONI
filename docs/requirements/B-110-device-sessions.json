{
  "req_id": "REQ-0110",
  "title": "Device Session Management (Active Sessions, Revocation)",
  "version": "1.0",
  "status": "in-design",
  "domain": "messaging",
  "depends_on": ["REQ-0061"],
  "use_cases": [
    "user logs in on mobile → creates session",
    "user logs in on web → creates separate session",
    "user checks 'Active Sessions' → sees mobile + web + desktop (if logged in)",
    "user taps 'Revoke' on old web session → logs out that session"
  ],
  "session_creation": {
    "on_login": [
      "1. user authenticates (email + password or OAuth)",
      "2. system generates session_token (long-lived, 30 days)",
      "3. generate device_id (unique per device/browser/app combo)",
      "4. INSERT sessions (user_id, device_id, session_token, created_at)"
    ]
  },
  "session_identification": {
    "device_name": "auto-generate from User-Agent (e.g., 'Safari on iPhone 14')",
    "last_active": "track last_activity_at (updated on each API call)",
    "ip_address": "store IP for security anomaly detection"
  },
  "session_storage": {
    "redis": "session_token → {user_id, device_id, expires_at} (fast lookup)",
    "postgres": "sessions table (audit trail, long-term storage)"
  },
  "database_schema": {
    "sessions_table": {
      "columns": [
        "session_id UUID PK",
        "user_id UUID FK",
        "device_id VARCHAR(100) UNIQUE per user",
        "device_name VARCHAR(50) (Safari on iPhone, Chrome on Desktop, etc)",
        "session_token TEXT (hashed)",
        "ip_address INET",
        "created_at TIMESTAMP",
        "last_activity_at TIMESTAMP",
        "expires_at TIMESTAMP (30 days from creation)",
        "is_active BOOLEAN",
        "revoked_at TIMESTAMP (NULL if still active)"
      ]
    }
  },
  "ui": {
    "active_sessions_screen": {
      "location": "settings → security → 'Active Sessions'",
      "display": [
        {
          "device_name": "Safari on iPhone",
          "ip_address": "192.168.1.10",
          "last_active": "2 minutes ago",
          "created_at": "Feb 10, 2026",
          "action": "Current session ✓"
        },
        {
          "device_name": "Chrome on Desktop",
          "ip_address": "203.0.113.45",
          "last_active": "Feb 14",
          "created_at": "Feb 8",
          "action": "[Revoke Session]"
        }
      ]
    }
  },
  "session_revocation": {
    "flow": [
      "1. user taps 'Revoke' on a session",
      "2. system sets is_active=false, revoked_at=NOW()",
      "3. if session is current device, user is logged out",
      "4. deleted from Redis, so next API call with old token fails"
    ]
  },
  "session_expiration": {
    "ttl": "30 days from creation",
    "auto_logout": "session expires → user must re-login",
    "refresh_token": "optional: allow refresh_token to extend session (not required for v1)"
  },
  "suspicious_activity": {
    "detection": "if multiple logins from different IPs in <5 minutes, flag as suspicious",
    "action": "email user: 'New login detected from [IP]. Not you? Revoke session.'"
  },
  "logout_all_sessions": {
    "feature": "user can 'Logout All Sessions' button (revoke everything except current)",
    "security": "protect against account takeover"
  },
  "api_endpoints": {
    "login": {
      "endpoint": "POST /v1/auth/login",
      "payload": {
        "email": "user@example.com",
        "password": "secret"
      },
      "response": {
        "session_token": "token_abc123xyz",
        "expires_in_seconds": 2592000
      }
    },
    "list_active_sessions": {
      "endpoint": "GET /v1/user/sessions",
      "response": [
        {
          "session_id": "UUID",
          "device_name": "Safari on iPhone",
          "ip_address": "192.168.1.10",
          "last_activity_at": "2026-02-15T15:35:00Z",
          "created_at": "2026-02-10T10:00:00Z",
          "is_current": true
        }
      ]
    },
    "revoke_session": {
      "endpoint": "DELETE /v1/user/sessions/{session_id}",
      "response": {
        "revoked_at": "2026-02-15T15:36:00Z"
      }
    },
    "logout_all_sessions": {
      "endpoint": "POST /v1/auth/logout-all",
      "note": "revokes all sessions except current device"
    },
    "verify_session": {
      "endpoint": "GET /v1/auth/verify",
      "headers": {
        "Authorization": "Bearer session_token"
      },
      "response": {
        "user_id": "UUID",
        "valid": true
      }
    }
  },
  "security": {
    "token_storage": "client must store securely (secure cookie for web, secure storage for mobile)",
    "token_transmission": "always over HTTPS (TLS 1.3+)",
    "token_rotation": "optional: rotate token every 24h (send new token in API response)"
  },
  "monitoring": {
    "metrics": [
      "sessions.active_count_per_user",
      "sessions.avg_session_duration",
      "sessions.logout_rate",
      "sessions.suspicious_login_attempts"
    ],
    "alerts": [
      "suspicious_login: multiple IPs in <5min (potential account takeover)",
      "session_revocation_spike (user mass-revoking? potential breach)"
    ]
  },
  "testing": {
    "scenarios": [
      "login on mobile → session created, token returned",
      "login on web simultaneously → 2 active sessions",
      "list sessions → show both mobile + web",
      "revoke web session → web logged out, mobile still active",
      "session expires (30 days) → next API call returns 401, must re-login",
      "logout_all → all sessions except current revoked"
    ]
  }
}
