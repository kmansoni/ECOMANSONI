# v2.8 Non-Bypass Final Spec - Platform Core Governance, Consistency, Safety

Status: Final Review
Owners: Core Architecture (primary), Security (co-owner)

## 0) Scope and goal
This spec defines non-bypass guarantees for platform core: scopes, DM, invites, timeline, audit, idempotency, policy, maintenance, and operational safety.

Non-bypass means invariants hold under:
- race/concurrency
- retries/timeouts
- UI/FE bugs
- legacy endpoints
- partial deployments
- malicious client behavior
- service key leak (bounded by controls)

## 1) Definitions
- Scope: dm | group | channel | service
- DM: 1:1 scope between two identities
- Policy: visibility/join/delivery configuration for a scope
- Registry SSOT: compiled registry JSON is source of truth
- Event store: immutable facts only
- State tables: authoritative pointers (memberships, receipts)

## 2) Hard invariants (INV-*)
INV-DM-01: DM uniqueness per (A,B) pair.
INV-POL-01: Join eligibility is server-validated by registry policy.
INV-SEQ-01: Gap detection is mandatory.
INV-QRY-01: Timeline limit and lookback are strictly capped.
INV-AUD-01: Edit/delete audit semantics are canonical in DB, not UI.
INV-DEL-01: delivery_strategy is explicit per scope.
INV-IDEMP-01: Idempotency identity is (actor_id, scope_id, command_type, idempotency_key_norm).
INV-GOV-01: Registry schema and compiled outputs require owner approvals.
INV-MEM-01: Removed members have pointers cleared and dialogs projection removed.
INV-INV-01: Private/unlisted joins are auditable and recoverable.
INV-MAINT-01: Maintenance modes enforce write freeze and read safety.
INV-HASH-01: Policy hash required for policy-affecting changes.
INV-CLASS-01: Data classification is derived from registry only.
INV-SLO-01: Outcome lookup SLOs are enforced.
INV-BATCH-01: Batch mutations are forbidden in v2.8.

## 3) Idempotency model
### 3.1 Identity
(actor_id, scope_id, command_type, idempotency_key_norm)

### 3.2 Normalization
- UUID -> lowercase
- ULID -> uppercase
Store normalized key only.

### 3.3 Perpetual idempotency (fixed retention)
Two-tier model:
- idempotency_outcomes_hot: IDEMP_RETENTION_YEARS = 2
- idempotency_outcomes_archive: ARCHIVE_RETENTION = indefinite
- idempotency_locks: short TTL for in-flight races

Retention values are fixed invariants. Changes require Core + Security approval and release gating.

### 3.4 Payload hash
Payload hash uses RFC 8785 JSON Canonicalization Scheme (JCS):
- UTF-8
- object keys sorted lexicographically
- no insignificant whitespace
- numbers normalized (1 == 1.0)
- booleans lowercase
- null explicit
- arrays preserve order

### 3.5 Retention semantics
Messages/events may purge by classification/retention rules if seq invariants remain intact.
Idempotency outcomes are archived, not deleted, to preserve anti-replay and anti-duplication guarantees.
If legal deletion is required, it must be implemented as a separate, explicitly approved policy with documented risk to perpetual idempotency.
Outcomes are an explicit retention exception: they are archived and never purged by classification retention rules.

## 4) DM determinism
- Canonical pair (low, high) by UUID order.
- dm_user_low/high required for dm scopes.
- Unique partial index on (dm_user_low, dm_user_high) where scope_type='dm'.
- dm_user_low <> dm_user_high unless self-DM is explicitly allowed by deployment.

Self-DM is a deployment-time invariant, not a runtime toggle. Changing it requires freeze and migration.

Migration conflict resolution:
- If duplicate DMs exist before enforcement, a migration must deduplicate by canonical pair.
- All but one DM per pair must be marked for retention (legal hold) or merged.
- New DM creation after enforcement always rejects duplicates with dm_already_exists.

## 5) Scope policy and visibility
### 5.1 Policy-affecting fields
Only these bump policy_version:
- visibility
- join_mode
- delivery_strategy
- approval_roles
- approval_quorum
- self_join_enabled
- invite_ttl
- data_classification_defaults

### 5.2 policy_object_for_hash
policy_hash is computed from a canonical JSON object containing exactly the policy-affecting fields above and nothing else. Metadata fields are excluded.

policy_hash = sha256(JCS(policy_object_for_hash))

Invites store policy_version_at_issue and policy_hash_at_issue. Accept requires both to match current scope policy.

### 5.3 Visibility/join rules
Allowed combinations:
- public: open | approval
- private: invite_only | approval
Invalid combinations are rejected server-side.

### 5.4 Visibility transitions
Allowed transitions:
- private -> unlisted: allowed
- unlisted -> public: allowed
- public -> unlisted: allowed
- unlisted -> private: allowed
- public -> private: forbidden without freeze + reindex

All other transitions are rejected with visibility_transition_forbidden.

## 6) delivery_strategy
- DM/Group: fanout_on_write allowed.
- Channel (large): fanout_on_read required.
- Strategy changes require freeze + rebuild, otherwise reject.

If "large" is not explicitly set, channels default to fanout_on_read unless SRE provides a whitelist for exceptions.

Large channel criteria must be explicit:
- channel_type=large OR member_count >= 50,000

## 7) Membership and receipts
- Receipts are per-user pointers: (user_id, scope_id).
- Monotonic rules: last_read_seq <= last_delivered_seq <= scope_max_seq; no decreases.
- Removed members: membership state removed, pointers cleared, dialogs projection removed.
- Rejoin requires new invite or admin re-add.

## 8) Invites
- Invite TTL required for private.
- Accept is idempotent.
- policy_version/hash pinned at issue.
- Policy change invalidates outstanding invites.
- Accept on removed membership -> reject (membership_revoked).

Public scopes with join_mode=open do not use invites. Any invite created for public/open is rejected with invite_not_applicable.

## 9) Timeline and sync
/q/timeline:
- limit <= 200 (hard cap)
- TIMELINE_LOOKBACK_DAYS = 30
- returns scope_max_seq
- rate-limited per (actor_id, scope_id), per actor global cap, and per delegated_user_id if present
- rate limit keys: actor_id, device_id (optional), service_id (service context)

Gap detection:
- client must report missing_ranges
- server validates realism and rate limits
- server responds with patch or resync.required
- ack cannot advance beyond last_contiguous_seq

## 10) /cmd/status contract
Request identity: (actor_id, scope_id, command_type, idempotency_key_norm)
Response:
- state: found_hot | found_archive | pending | not_found | error
- source: hot | archive | none
- outcome: opaque payload or outcome_code
- retry_after_ms for pending or archive_unavailable

/cmd/status must only return outcomes for the same actor_id (or delegated_user_id) as the request. Cross-actor access is forbidden.

If /cmd returns 202 outcome_archived_check_required, client must call /cmd/status using the same identity.

Archive failure behavior:
- 503 archive_unavailable, retryable=true, circuit breaker enforced.

## 11) Maintenance modes
system_mode:
- normal
- maintenance_write_freeze
- read_only_safe
- maintenance_full (optional)

Transitions (allowed):
- normal -> maintenance_write_freeze
- maintenance_write_freeze -> read_only_safe
- maintenance_write_freeze -> maintenance_full (dual approval)
- read_only_safe -> maintenance_write_freeze (back transition)
- maintenance_full -> maintenance_write_freeze

Forbidden transitions:
- normal -> read_only_safe
- normal -> maintenance_full
- read_only_safe -> maintenance_full without maintenance_write_freeze

Guards:
- maintenance_full forbidden if purge_jobs_active=true or migration_journal.in_progress=true.
- maintenance transitions are rate-limited (max 3 per hour).
- maintenance transitions require audit logging with reason_code.

read_only_safe:
- reads served via API version pinning or stable read views
- X-Api-Read-Version required; absence -> read_version_required

## 12) Audit and edit/delete semantics
Canonical audit fields (core_messages): edited_at, edit_count, deleted_at, deleted_by, tombstone placeholder.
Immutability:
- deleted_at only null->timestamp
- edit_count only increments
- deleted_by set once

Admin actions require reason_code allowlist and reason_text max length; PII forbidden in reason_text.
Allowed reason_code values:
- abuse_spam
- abuse_harassment
- legal_request
- user_request
- security_incident
- moderation_policy
- other (requires reason_text)

## 13) Data classification
Classification per command/event in registry:
- normal
- sensitive
- regulated

Retention mapping:
- normal: 365 days
- sensitive: 180 days
- regulated: 730 days

No manual overrides.

Classification applies to events, audit payloads, and retention policy selection.

## 14) Outcome archive lookup SLO
- /cmd uses hot store only
- archive lookup only via /cmd/status
- p95 SLO: hot <= 50ms; archive <= 500ms
- missing in hot -> 202 outcome_archived_check_required

## 15) Clock skew
- client_ts only for replay window
- MAX_CLOCK_SKEW = 5 min
- server returns server_time + skew_hint on reject
- ordering uses server created_at + seq only

## 16) Registry governance
- compiled registry JSON is SSOT
- schemas and docs generated or CI-verified
- CODEOWNERS + 2 approvals
- registry schema changes are release blockers

Registry schema ownership requires Core + Security approvals and branch protection.

Write-surface inventory is mandatory: the only approved mutation endpoints/RPCs must be listed and versioned. Direct writes to core_* outside this list are forbidden.

## 17) Runtime guards registry (G-*)
All runtime guards are enumerated and referenced in threat coverage:
- G-IDEMP-01: idempotency identity enforcement
- G-IDEMP-02: payload hash mismatch guard
- G-POL-01: policy visibility/join enforcement
- G-SEQ-01: gap realism validation
- G-QRY-01: timeline caps
- G-MAINT-01: maintenance freeze gate
- G-INV-01: invite policy/version check
- G-DEL-01: delivery_strategy enforcement
- G-CLK-01: clock skew guard
- G-ADM-01: admin reason allowlist + PII screen
- G-BATCH-01: batch forbidden guard
- G-PROJ-01: watermark monotonic enforcement
- G-ARC-01: archive circuit breaker

## 18) projection_watermarks contract
Table: projection_watermarks(scope_id, dialogs_watermark_seq, unread_watermark_seq, updated_at, version)
Rules:
- monotonic only
- only projection service role may update
- rebuild uses read_only + watermark stable

projection_mode:
- normal | rebuilding | read_only
projection_mode is stored in DB and returned by /q endpoints during rebuild.

## 19) Service key leak controls (explicit)
- service keys never exposed to client
- network ACL restricts service endpoints
- key rotation: monthly with emergency rotation on compromise
- last_rotated_at tracked; ops check enforces last_rotated_at <= 35 days
- anomaly detection for spikes in /cmd and scope creation

## 20) Acceptance tests (T-*)
Minimal required list:
- T-DM-01, T-DM-02, T-DM-SELF-01/02
- T-IDEMP-02..04, T-IDEMP-PAYLOAD
- T-POL-01, T-POL-HASH-01/02
- T-QRY-01, T-QRY-THR-01/02
- T-SEQ-01..04
- T-AUD-01, T-AUD-RET-01/02
- T-INV-01..04, T-INV-REJOIN-01
- T-DEL-01
- T-MIG-READ-01..03, T-MIG-RESUME-01/02
- T-PROJ-01/02
- T-GOV-01
- T-CHAOS-01 (critical scenarios)

Batch forbidden:
- T-BATCH-01: /cmd/batch returns not_supported

No PR touching core may merge without these tests green.

## 21) Threat model and chaos references
- STRIDE + LINDDUN coverage required
- threat coverage gate requires 100% mapping to guard + test + invariant
- chaos scenarios are release blockers per severity

## 22) Release gate
No release until:
- registry + docs + schemas in sync
- tests in section 20 pass
- threat model and chaos matrix approved
- acceptance criteria satisfied

## 23) Out of scope (security)
- DB superuser compromise
- OS/kernel compromise
- hypervisor compromise
- KMS/secrets manager compromise
- physical access to storage

---

# END v2.8-non-bypass-final-rev2.md
