name: Deploy Sync (GitHub -> Supabase + AdminVPS)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run dry-run only"
        required: false
        default: "false"

concurrency:
  group: deploy-sync-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
      SUPABASE_CHECK_TABLES: ${{ secrets.SUPABASE_CHECK_TABLES }}
      ADMINVPS_HOST: ${{ secrets.ADMINVPS_HOST }}
      ADMINVPS_SSH_PORT: ${{ secrets.ADMINVPS_SSH_PORT }}
      ADMINVPS_USER: ${{ secrets.ADMINVPS_USER }}
      ADMINVPS_SSH_KEY: ${{ secrets.ADMINVPS_SSH_KEY }}
      ADMINVPS_BACKUP_DIR: ${{ secrets.ADMINVPS_BACKUP_DIR }}
      ADMINVPS_APP_DIR: ${{ secrets.ADMINVPS_APP_DIR }}
      ADMINVPS_SYSTEMD_SERVICES: ${{ secrets.ADMINVPS_SYSTEMD_SERVICES }}
      ADMINVPS_HEALTH_URL: ${{ secrets.ADMINVPS_HEALTH_URL }}
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || secrets.SUPABASE_URL }}
      VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY || secrets.VITE_SUPABASE_ANON_KEY || secrets.SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install dependencies
        run: npm ci

      - name: Preflight checks
        run: |
          set -e
          [ -n "$SUPABASE_DB_URL" ]
          if [ "$DRY_RUN" != "true" ]; then
            [ -n "$SUPABASE_ACCESS_TOKEN" ]
            [ -n "$ADMINVPS_HOST" ]
            [ -n "$ADMINVPS_USER" ]
            [ -n "$ADMINVPS_SSH_KEY" ]
            [ -n "$ADMINVPS_BACKUP_DIR" ]
            [ -n "$ADMINVPS_APP_DIR" ]
            [ -n "$VITE_SUPABASE_URL" ]
            [ -n "$VITE_SUPABASE_PUBLISHABLE_KEY" ]
          fi

      - name: Dry run notice
        if: ${{ env.DRY_RUN == 'true' }}
        run: echo "Dry run enabled. Deploy steps will be skipped."

      - name: Build frontend
        run: npm run build

      - name: Deploy Supabase (migrations + functions + secrets)
        if: ${{ env.DRY_RUN != 'true' }}
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/supabase-deploy.ps1 -SkipSyncGuard -SkipDbPush

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Create Supabase backup
        if: ${{ env.DRY_RUN != 'true' }}
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/supabase-backup-to-adminvps.ps1 -DbUrl "$SUPABASE_DB_URL"

      - name: Supabase integrity check (row counts + checksums)
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File scripts/supabase-integrity-check.ps1 -DbUrl "$SUPABASE_DB_URL" -Tables "$SUPABASE_CHECK_TABLES"

      - name: Upload backup to AdminVPS
        if: ${{ env.DRY_RUN != 'true' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ADMINVPS_HOST }}
          port: ${{ env.ADMINVPS_SSH_PORT || '22' }}
          username: ${{ env.ADMINVPS_USER }}
          key: ${{ env.ADMINVPS_SSH_KEY }}
          source: ".tmp/supabase-backups/*"
          target: ${{ env.ADMINVPS_BACKUP_DIR }}

      - name: Upload integrity artifacts to AdminVPS
        if: ${{ env.DRY_RUN != 'true' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.ADMINVPS_HOST }}
          port: ${{ env.ADMINVPS_SSH_PORT || '22' }}
          username: ${{ env.ADMINVPS_USER }}
          key: ${{ env.ADMINVPS_SSH_KEY }}
          source: ".tmp/supabase-integrity/*"
          target: ${{ env.ADMINVPS_BACKUP_DIR }}/integrity

      - name: Deploy to AdminVPS
        if: ${{ env.DRY_RUN != 'true' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.ADMINVPS_HOST }}
          port: ${{ env.ADMINVPS_SSH_PORT || '22' }}
          username: ${{ env.ADMINVPS_USER }}
          key: ${{ env.ADMINVPS_SSH_KEY }}
          script: |
            set -e
            export APP_DIR="${{ env.ADMINVPS_APP_DIR }}"
            export SYSTEMD_SERVICES="${{ env.ADMINVPS_SYSTEMD_SERVICES }}"
            export DRY_RUN="${{ env.DRY_RUN }}"
            export VITE_SUPABASE_URL="${{ env.VITE_SUPABASE_URL }}"
            export VITE_SUPABASE_PUBLISHABLE_KEY="${{ env.VITE_SUPABASE_PUBLISHABLE_KEY }}"
            cd "$APP_DIR"
            if [ -n "$(git status --porcelain)" ]; then
              git stash push -u -m "gha-auto-stash-$(date +%Y%m%d-%H%M%S)" >/dev/null || true
            fi
            git fetch origin main
            git checkout main
            git pull --ff-only origin main
            printf 'VITE_SUPABASE_URL="%s"\nVITE_SUPABASE_PUBLISHABLE_KEY="%s"\n' "$VITE_SUPABASE_URL" "$VITE_SUPABASE_PUBLISHABLE_KEY" > .env.production
            npm ci
            npm run build
            if [ -n "$SYSTEMD_SERVICES" ]; then
              for svc in $SYSTEMD_SERVICES; do
                sudo systemctl restart "$svc"
              done
            fi

      - name: Verify AdminVPS backup retention
        if: ${{ env.DRY_RUN != 'true' }}
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.ADMINVPS_HOST }}
          port: ${{ env.ADMINVPS_SSH_PORT || '22' }}
          username: ${{ env.ADMINVPS_USER }}
          key: ${{ env.ADMINVPS_SSH_KEY }}
          script: |
            set -e
            mkdir -p "${{ env.ADMINVPS_BACKUP_DIR }}"
            find "${{ env.ADMINVPS_BACKUP_DIR }}" -type f -mtime +30 -delete

      - name: Health check (optional)
        if: ${{ env.DRY_RUN != 'true' && env.ADMINVPS_HEALTH_URL != '' }}
        run: |
          curl -f "${{ env.ADMINVPS_HEALTH_URL }}"

      - name: Done
        run: echo "Deploy sync complete."
